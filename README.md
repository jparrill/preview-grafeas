# Grafeas

## Overview

Grafeas defines metadata API spec for computing components (e.g., VM images, container images, jar files, scripts) that can assist with aggregations over your metadata. Grafeas uses two API concepts, a note and an occurrence. This division allows 3rd party metadata providers to create and manage metadata on behalf of many customers. Additionally, the division also allows implementation of access control settings that allow fine grain access control.

In grafeas we have two elements, I will use an analogy to make it simple:

- **Notes**: It's the definition of a object that you are looking for EG 'CVE-2017-14159' 
- **Occurrences**: It's the existence of the note on a Docker Container, RPM, Etc... 

## Where we start?

This repository contains an ansible playbook that create a couple of containers, one of the to compile the data _(build time)_ and the other one to expose the API. 

### Requirements

- Fedora/Centos:
  - docker
  - python
  - ansible

### Provision Server

Execute this command against:

- localhost
```
ansible-playbook -i 'localhost,' provision.yml
```

- Fresh Fedora27 image
```
ansible-playbook -i '192.168.122.166,' provision.yml -e "vm=true"
```

The result will be in both cases:
```
âžœ  ~ docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                                NAMES
641813e34527        grafeas-server      "/grafeas-server"   3 minutes ago       Up 3 minutes        8080/tcp, 0.0.0.0:10000->10000/tcp   grafeas-server_01
```

The server will be running on 10000 port and you must make the requests to _http://<ip>:10000/_. In the configuration file of the client you could set the url and port.

### Installing the client

I will give a try to the Python one, just follow this steps:

```
virtualenv -p python .virtualenv
source .virtualenv/bin/activate
git clone https://github.com/Grafeas/client-python.git
cd client-python/v1alpha1
```

Add this line to setup.py:

```
      ...
      include_package_data=True,
+     zip_safe=False,
      long_description="""\
      ...
```

Save and install the client in the venv:

```
python setup.py install
```

Modify this file to point to the correct server:

- .virtualenv/lib/python2.7/site-packages/swagger_client-1.0.0-py2.7.egg/swagger_client/configuration.py
```
...
...
    def __init__(self):
        """
        Constructor
        """
        # Default Base url
        self.host = "http://<host>:10000"
...
...
```

Ok, we are now ready to start testing Grafeas. In this repository you have a client.py that could help you to understand how the client works ;).

### Client.py

This script will help you to understand how grafeas python-client works, the code is simple. Just modify as your needs to test the server.

Enjoy!

### The problem

The python client is autogenerated by Swagger, then it seems that do not work propertly, sending this data to the server we receive this other one. (The correct behaviour must be, all that are inserted in grafeas will be included into the server response)

- Request
```json
{"update_time": "2017-12-19T16:06:08.109137", "name": "project/test01/notes/CVE-2017-14976", "vulnerability_type": "Security", "package": "poppler", "related_url": "https://security-tracker.debian.org/tracker/CVE-2017-14976", "kind": "PACKAGE_VULNERABILITY", "create_time": "2017-12-19T16:06:08.109118", "short_description": "test01", "expiration_time": "", "base_image": "rakudo-star", "long_description": ""}
```

- Response
```json
{'attestation_authority': None,
 'base_image': None,
 'build_type': None,
 'create_time': None,
 'deployable': None,
 'discovery': None,
 'expiration_time': None,
 'kind': None,
 'long_description': None,
 'name': None,
 'operation_name': None,
 'package': None,
 'related_note_names': None,
 'related_url': None,
 'short_description': None,
 'update_time': None,
 'vulnerability_type': None}
```

I was modifying the python client to figure out what could be the problem but the binary API is a mess to be debugged :/. 

## References

- [Grafeas Website](https://grafeas.io)
- [Grafeas GH](https://github.com/Grafeas/Grafeas)
- [Grafeas Blog - 01](https://cloudplatform.googleblog.com/2017/10/introducing-grafeas-open-source-api-.html)
- [Grafeas Blog - 02](https://www.infoworld.com/article/3230462/security/what-is-grafeas-better-auditing-for-containers.html)
- [Kubecon Presentation](https://schd.ws/hosted_files/kccncna17/c6/KubeCon%202017_%20Grafeas%20BoF%202017-12-06.pdf)
- [Kubecon Grafeas Meetup](https://schd.ws/hosted_files/kccncna17/6a/KubeCon%202017_%20Grafeas%20Meet-Up%20%282017-12-08%29.pdf)
- [Grafeas Python Client](https://github.com/Grafeas/client-python)

# Kritis

## To be continue...

## References

- [Kritis GH](https://github.com/Grafeas/Grafeas/blob/master/case-studies/binary-authorization.md)
